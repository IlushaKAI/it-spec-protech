Status:
Created: 28.07.2025
Tags: [[стажировка ИТ протех]]

Конспект лекции Кетова

## Что такое домен
Под доменом будем понимать 2 услуги:
1. Централизованное хранение учетных записей и связанных с ними свойств, например группы безопасности, различные свойства, описания, отношения подчиненный-управляющий для отражения организационной структуры
LDAP(Lightweight Directory Access Protocol) подчиняется спецификации X500. Этот протокол позволяет обращаться в каталог, расположенный на сервере домена, и получать услугу централизованного хранения. 

2. Централизованная аутентификация
Протокол Kerberos позволяет получать взаимную аутентификацию - службы относительно пользователя и пользователя относительно службы. В первом случае подразумевается, что служба желает давать доступ только аутентифицированным пользователям. Во втором - пользователи желают знать, что они подключаются к легитимной службе.

Не стоит путать аутентификацию и авторизацию.
Аутентификация - способ проверки подлинности пользователя
Авторизация - определение полномочий пользователя, разграничение прав

## Как это применимо в реальной работе организации
Доступ к корпоративной службе(helpdesk, почта) и определенным возможностям администрирования локального устройства появится только при наличии учетной записи в домене и наличии соответствующих прав.

В случае отсутствия интеграции устройств в домен, придется на каждом отдельном устройстве заниматься управлением учетных записей и прав, что очевидно очень ресурсозатратно

## Почему именно LDAP
Даже не смотря на то, что доменная инфраструктура в организациях зачастую реализована при помощи Windows серверов, часто возникает необходимость подружить какую-нибудь службу, развернутую на серверах Linux, с этой Windows инфраструктурой. В этом и помогает LDAP. В системах Linux тоже существуют службы, позволяющие развернуть доменную инфраструктуру, например SambaDC или FreeIPA

## Причем здесь DNS
Функционал организации доменной инфраструктуры прикладного уровня(как раз наши централизованные каталоги) базируется на организации доменов на сетевом уровне(DNS службы). Зачастую сервер домена является DNS сервером. Поэтому, чтобы ввести машины в доменную инфраструктуру, они должны знать о существовании в подсети общего DNS сервера. Автоматизировать этот процесс можно, дополнительно настроив DHCP сервер, чтобы он помимо выдачи ip адреса клиентам еще и выдавал адрес DNS сервера
## Рассмотренные утилиты
В качестве клиента ldap будет выступать утилита в терминале. Разумеется существуют и другие реализации клиентов ldap
Команда
```bash
ldapsearch -h t-winsrv.domain.ru -b "" -x
```

Запускает поиск с пустой базы (-b) и анонимно (-x)
![|500x168](../../../Файлы/images/LDAP%20и%20Kerberos%20часть%201-28.07.2025-10_07.png)
Выводит ошибку, так как вниз по дереву(subtree) нет никаких объектов, потому что в пустой базе описание сервера хранится в виде одного объекта, т.е. ветка дерева, в которой произведена попытка поиска, по сути просто отсутствует

Чтобы это исправить, нужно ограничить объем поиска только базой при помощи ключа -s(search)
```bash
ldapsearch -h t-winsrv.domain.ru -b "" -x -s base
```
![|500x147](../../../Файлы/images/LDAP%20и%20Kerberos%20часть%201-28.07.2025-11_07-1.png)
И уже видим поля namingContext - отсюда формируются ветки, отсюда можно отсчитываться
DC - domain component. Из них собирается FQDN(Fully qualified domain name)

![|422x279](../../../Файлы/images/LDAP%20и%20Kerberos%20часть%201-28.07.2025-11_07-2.png)
Также можем узнать дополнительную информацию - имя хоста и поддерживаемые способы аутентификации SASL
Это вся информация, которую можно узнать абсолютно публично - не проникая в дерево и не указывая учетные данные

Попробуем подключится к поддереву также анонимно:
```bash
ldapsearch -h t-winsrv.domain.ru -b dc=domain,dc=ru -x -s sub
```
и ожидаемо получаем ошибку
![|500x72](../../../Файлы/images/LDAP%20и%20Kerberos%20часть%201-28.07.2025-11_07-3.png)
Под bind подразумевается необходимость аутентификации и авторизации к каталогу

## Kerberos
Как и говорилось в самом начале - протокол взаимной аутентификации. В web это реализовано при помощи SSL сертификации - 3-ей стороны. Механизм работы Kerberos аналогичен

Состоит из 2-ух услуг:
1. Получение билетов - TGT(Ticket granting ticket)
2. Получение доступа к службе - TGS(Ticket get service)
Используется для одноразовой авторизации. 

Шаги со стороны пользователя
1. Получаем билет от TGT
2. Получаем билет от TGS, который предоставляет возможность подключения к самим службам
![|359x182](../../../Файлы/images/LDAP%20и%20Kerberos%20часть%201-28.07.2025-12_07.png)
Последующие подключения к службам проводятся без 1-ого этапа. При этом нигде не кэшируем пароль, так как Kerberos сервер уже уверен в нас.
Но нам нужен клиент Kerberos чтобы иметь возможность выполнить первый этап.
Таким клиентом может являться утилита kinit реализация krb5-user от MIT
То что в Microsoft называется домен, в Kerberos называется realm. Это регистрозависимый параметр, который нужно вводить в верхнем регистре.
![|483x208](../../../Файлы/images/LDAP%20и%20Kerberos%20часть%201-28.07.2025-12_07-1.png)

При запуске утилиты производится запрос в DNS, чтобы узнать где находится сервер kerberos
![|526x36](../../../Файлы/images/LDAP%20и%20Kerberos%20часть%201-28.07.2025-12_07-2.png)

kinit обращается к конфигурационному файлу, но можно и вручную указать параметры при запуске
![|500x144](../../../Файлы/images/LDAP%20и%20Kerberos%20часть%201-28.07.2025-12_07-4.png)
Получаем билет на получение билетов

Теперь при попытке сканирования дерева
```bash
ldapsearch -h t-winsrv.domain.ru -b dc=domain,dc=ru -s sub
```
ldapsearch за нас все проверяет и выполняет, но у нас не установлен модуль SASL, который поддерживал бы аутентификацию по kerberos
![|500x63](../../../Файлы/images/LDAP%20и%20Kerberos%20часть%201-28.07.2025-12_07-5.png)

Нужно использовать модуль libsasl2-modules-gssapi-mit

В следующих частях Кетов настраивает обратную dns зону и добавляет пользователей в каталог при помощи функционала ldapadd и ldapmod, передавая им файлы формата .ldif
Настраивает доступ по ssh без пароля, а по kerberos
Быстрая демонстрация в третей части с 1:20:00
## Источники инфы
https://www.youtube.com/watch?v=RZZol_P42PA&t=3467s&ab_channel=DmitryKetov
